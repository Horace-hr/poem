var NP_config={loadingImg:'img/NP_loading.gif',showClass:'page-show',baseClass:'page',menuId:'menu',menuItemClass:'item',menuShowClass:'cur',host:getHost(),service:getHost(),start:'N.',end:'.L',loginPageId:'page_login',pageRoute:'/page',defaultPage:'index',defaultParams:''};var NP_DATA={startParams:null,historyAction:null,pageParams:{},cookieUid:null};function getHost(){var h=location.href;var p=location.pathname;return h.substr(0,h.indexOf(p))}function t_getUrlParamsJson(){var paramsJson={page:NP_config.defaultPage,params:NP_config.defaultParams};var href=location.href;var queryStr=location.search;NP_DATA['historyAction']=href.replace(queryStr,'');if(!queryStr)return paramsJson;var arr=location.search.substring(1).split("&");for(var i=0;i<arr.length;i++){var pairs=arr[i];var pos=pairs.indexOf('=');if(pos==-1)continue;paramsJson[pairs.substring(0,pos)]=decodeURI(pairs.substring(pos+1))}return paramsJson}function generateUUID(){var d=new Date().getTime();return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=(d+Math.random()*16)%16|0;d=Math.floor(d/16);return(c=='x'?r:(r&0x3|0x8)).toString(16)})}function setCookie(name,value,days){if(days){var date=new Date();date.setTime(date.getTime()+(days*24*60*60*1000));var expires="; expires="+date.toGMTString()}else expires="";document.cookie=name+"="+value+expires+"; path=/"}function getCookie(name){var nameEQ=name+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==' ')c=c.substring(1,c.length);if(c.indexOf(nameEQ)==0)return c.substring(nameEQ.length,c.length)}return null}var NP_component={loading:function(isLoading){var loading=$('#NP_loading');if(loading.length==0){loading=$('<div id="NP_loading" style="position: fixed;top: 0;left: 0;right: 0;bottom: 0;z-index: 20170107;text-align: center;"><img style="height: 26px;width: 26px;position: absolute;top: 50%;margin-top: -13px;left: 50%;margin-left: -13px;" src="'+NP_config.loadingImg+'"/></div>');$('body').append(loading)}if(isLoading){loading.show()}else{loading.hide()}},setMemu:function(targetPage){var menu=$('#menu');if(menu.length==0||targetPage.length==0)return false;var tm=targetPage.data('menu');if(!!tm&&tm!='-1'){var items=menu.find('.item');items.removeClass(NP_config.menuShowClass);items.removeClass('sec');items.each(function(i){var sort=$(this).data('sort');if(sort==tm){$(this).addClass(NP_config.menuShowClass)}});menu.find('.item').not('.cur').eq(1).addClass('sec');menu.show()}else{menu.hide()}},scroll:function(targetPage){var pos=targetPage.attr('data-pos');if(!pos)pos=0;$('body').scrollTop(pos)},loadHtml:function(fileName){var url=NP_config.host+NP_config.pageRoute+"/"+fileName;var html=null;$.ajax({url:url,async:false,type:"post",dataType:'text',success:function(result){var holder=new RegExp(NP_config.start+'host'+NP_config.end,"g");var val=NP_config.host;result=result.replace(holder,val);html=$(result);$('body').prepend(html)}});return html},fill:function(baseHtml,data,isPrev){var html=baseHtml.toString();var holder,val,obj;if(!data){data={}}data['host']=NP_config.host;for(var key in data){holder=new RegExp("N."+key+'.L',"g");val=data[key];html=html.replace(holder,val)}obj=$(html);NP_component.loadImg(obj,isPrev);return obj},preloadPage:function(showingPage){var preloads=showingPage.attr('data-preload');if(!preloads)return false;var items=preloads.split(',');var fileName,existPage;for(var i=0;i<items.length;i++){fileName=items[i];existPage=$('#page_'+fileName);if(existPage.length==0){NP_component.loadPage(fileName,function(res,pageId){var page=$(res);page.attr('id','page_'+pageId);$('body').prepend(page)})}}},loadPage:function(pageId,success){var url=NP_config.host+NP_config.pageRoute+"/page_"+pageId+".html";var loader=NP_component.createLoader();loader.load(url,function(result,status){if(status=='success'){var holder=new RegExp(NP_config.start+"host"+NP_config.end,"g");result=result.replace(holder,NP_config.host).replace(new RegExp(NP_config.start+"service"+NP_config.end,"g"),NP_config.service).replace(new RegExp(NP_config.start+"cid"+NP_config.end,"g"),NP_DATA.cookieUid);if($.isFunction(success)){success(result,pageId)}}else{console.error('[niepErro]：page_'+pageId+".html不存在")}});loader.empty()},createLoader:function(){var loader=$('#NP_loader_container');if(loader.length!=0)return loader;loader=$('<div id="NP_loader_container" style="display: none;"></div>');$('body').append(loader);return loader},loadResources:function(params,targetPage,drawBoard){var startPage=NP_DATA.startParams.page;if(!startPage){NP_component.request(params,targetPage)}else{NP_component.loading(true);NP_component.loadPage(startPage,function(result){var page=$(result);page.find('[data-prev="true"]').each(function(){$(this).attr('data-prev',false)});page.attr('id','page_'+startPage);$('body').prepend(page);NP_DATA.startParams['page']='';NP_component.request(NP_DATA.startParams.params,page)})}},request:function(params,target){var clone=target.data('clone');if(clone){var targetId=target.attr('id');var attachTimes=NP_DATA.pageParams[targetId+'_'+params];var cloneTarget=$("#"+targetId+"_"+attachTimes);if(cloneTarget.length==0){target=$(target.clone());var times=new Date().getTime();NP_DATA['pageParams'][targetId+'_'+params]=times;target.attr('id',targetId+"_"+times).attr('data-clone','body').attr('data-pageparams',params);$('body').append(target)}else{target=cloneTarget}}NP_component.title(target);target.attr('data-params',params);var html=target.html();html=html.replace(new RegExp(NP_config.start+"params"+NP_config.end,"g"),params);target.html($(html));var cmds=target.find('[data-unload="once"],[data-unload="refresh"]');NP_component.getData(target,params);if(cmds.length==0){target.pageShow()}},getData:function(targetPage,params){var cmds=targetPage.find('[data-unload="once"],[data-unload="refresh"]');targetPage.attr('data-count',cmds.length);cmds.each(function(){var ts=$(this);var cmd=eval(ts.data('cmd'));new cmd(ts,decodeURI(params),targetPage);if(ts.data('unload')=='once'){ts.attr('data-unload',false)}});targetPage.find('[data-unload="false"],[data-unload="refresh"]').each(function(){var ts=$(this);var prev=ts.attr('data-prev');if(prev=='preved'){NP_component.loadImg(ts,false)}})},loadImg:function(ts,isPrev){ts.find('img').each(function(){var cur=$(this);var defUrl=cur.data('default');if(isPrev==true){if(!!defUrl){cur.attr('src',defUrl)}}else{var loading=cur.data('loading');if(!!loading&&loading!='null'){cur.attr('src',loading)}else if(!!defUrl){cur.attr('src',defUrl)}}})},component:[],setComponent:function(ele,html){var params=!!ele.data('params')?ele.data('params'):'';NP_component.component[ele.data('cmd')+params]=html},getComponent:function(ele){var params=!!ele.data('params')?ele.data('params'):'';var keys=ele.data('cmd')+params;var jsons=NP_component.component;for(key in jsons){if(key==keys){return jsons[key]}}},getEleHtml:function(ele){var parent=$('<div></div>');parent.append(ele.clone());return parent.html()},backUrl:'',login:function(loginPageId){if(!loginPageId){loginPageId=NP_config.loginPageId}var curAddr=NP_component.backUrl;if(!curAddr){NP_component['backUrl']=window.location.href;curAddr=NP_component.backUrl}NP_component.switchPage({target:'#'+loginPageId,params:curAddr})},switchPage:function(params){if(!params){console.error('switchPage(params)中params参数缺失')}else if(!('target'in params)){console.error('switchPage(params)中target参数缺失')}var target=params.target;var switchBtn=$('<a href="" data-action="switch" data-params="" style="display:none">switchPage</a>');switchBtn.attr('href',target);switchBtn.attr('data-params',params.params);var showPage=Niep.getShowPage();if(showPage.length==0){showPage=$('body')}showPage.append(switchBtn);switchBtn.click()},small:function(tips,time,isTop){var name=isTop?'top':'bottom';var tipBtn=$("<div style='width:100% ; position:fixed ;text-align:center; "+name+":20%;left:0;' ><span style='background:#000;color:#fff;padding:10px 15px ; border-radius:4px'>"+tips+"</span></div>");$('body').append(tipBtn);if(!time)time=3000;tipBtn.fadeOut(time)},reloadPage:function(pages){for(var i=0;i<pages.length;i++){var ts=$('#page_'+pages[i]).find('[data-unload="false"]');ts.attr('data-unload','once').attr('pageNum',1)}},refreshCmd:function(cmd){$('[data-cmd="'+cmd+'"]').each(function(){if($(this).attr('data-unload')=='false'){$(this).attr('data-unload','once')}})},title:function(target){var title=target.data('title');if(!!title){document.title=title}else{document.title=NP_config.title}}};var NP_history={list:[],push:function(historyPage,targetPageId,params){var id=historyPage.attr('id');var list=NP_history.list;var last=list[list.length-1];if(list.length==0||id!=last.id){targetPageId="page="+targetPageId.split('_')[1];if(!!params){targetPageId=targetPageId+"&params="+params}if(!!NP_DATA.historyAction){targetPageId=NP_DATA.historyAction+"?"+targetPageId}history.pushState(id,id,targetPageId);list.push({id:id,html:historyPage.html()})}},back:function(){var list=NP_history.list;if(list.length>0){var target=list.pop();Niep.getShowPage().niepHide();var historyPage=$('#'+target.id);NP_component.loading(false);historyPage.html(target.html).niepShow();NP_component.scroll(historyPage);NP_component.setMemu(historyPage);NP_component.title(historyPage)}}};(function($){$.fn.pageShow=function(){var obj=this;if($.isFunction(NP_config.beforePageShow)){NP_config.beforePageShow(obj)}obj.loadStaticImg();NP_component.setMemu(obj);NP_component.loading(false);$('#loading').fadeOut();$('.'+NP_config.baseClass).removeClass('.'+NP_config.showClass);obj.niepShow();NP_component.scroll(obj);NP_component.preloadPage(obj);if($.isFunction(NP_config.afterPageShow)){NP_config.afterPageShow(obj)}};$.fn.pageHide=function(targetPageId,params){var obj=this;NP_history.push(obj,targetPageId,params);var pos=document.body.scrollTop;obj.attr('data-pos',pos);obj.find('[data-unload="refresh"]').each(function(){$(this).attr('pageNum','1')});obj.niepHide();NP_component.loading(true)};$.fn.loadStaticImg=function(isPrev){var obj=this;if(isPrev)return false;obj.find('img').each(function(){var ts=$(this);var statics=ts.data('static');if(!!statics){ts.attr('src',statics)}})};$.fn.pageList=function(datas,tips){var ele=this;var tips=datas.emptyTip;if(!tips)tips='Sorry,暂无数据哦~';var list=datas.page.list;var baseObj;var modal=ele.children().eq(0);var modalHtml=NP_component.getEleHtml(modal);var prevLoad=ele.data('prevLoad');var component=ele.attr('data-component-refresh-loaded');var unloadType=ele.data('unload');var pageNum=datas.page.pageNumber;var totalPage=datas.page.totalPage;if(!component){ele.attr('data-component-refresh-loaded',true);NP_component.setComponent(ele,modalHtml);ele.empty()}else{if(pageNum==1){ele.empty()}modalHtml=NP_component.getComponent(ele)}if(list.length==0){ele.html('<div style="text-align:center;font-size:12px;color:#bbb;">'+tips+'</div>').css('padding','20px');return}var moreBtn=ele.find('.getMoreDataBtn');if(moreBtn.length==0){moreBtn=$('<a href="javascript:;" class="getMoreDataBtn">加载更多…</a>');ele.append(moreBtn)}var allObj=[];for(var i in list){baseObj=NP_component.fill(modalHtml,list[i],prevLoad);baseObj.find('if').each(function(){var key=$(this).data('key');if(list[i][key]!=$(this).data('value')){$(this).remove()}else{$(this).next('else').remove()}});if(!!datas.deal&&typeof datas.deal!='undefined'||datas.deal!=undefined){datas.deal(baseObj,i)}allObj.push(baseObj.prop('outerHTML'))}if(datas.cutMore==true){ele.html(allObj.join(''))}else{moreBtn.before(allObj.join(''))}if(pageNum==totalPage||datas.cutMore==true){moreBtn.remove();if(datas.cutMore==true){if(pageNum==totalPage){ele.attr('pageNum',1)}else{ele.attr('pageNum',pageNum+1)}}}else if(pageNum!=totalPage&&(!prevLoad||(prevLoad&&(unloadType=='once'||unloadType=='false')))){ele.attr('pageNum',pageNum+1)}};$.fn.list=function(datas){var ele=this;var tips=datas.emptyTip;var list=datas.list;if(!tips)tips='Sorry,暂无数据哦~';var baseObj;var modal=ele.children().eq(0);var modalHtml=NP_component.getEleHtml(modal);var prevLoad=ele.data('prevLoad');var component=ele.attr('data-component-refresh-loaded');if(!component){ele.attr('data-component-refresh-loaded',true);NP_component.setComponent(ele,modalHtml);ele.empty()}else{ele.empty();modalHtml=NP_component.getComponent(ele)}if(list.length==0){ele.html('<div style="text-align:center;font-size:12px;color:#333;">'+tips+'</div>').css('padding','20px');return}for(var i in list){baseObj=NP_component.fill(modalHtml,list[i],prevLoad);if(!!datas.deal&&typeof datas.deal!='undefined'||datas.deal!=undefined){datas.deal(baseObj,i)}ele.append(baseObj)}};$.fn.fill=function(datas,deal){var ele=this;var objects={};if(!!datas){objects=datas}objects['host']=NP_config.host;var html=ele.html();if(!html)return false;var component=ele.attr('data-component-refresh-loaded');if(!component){ele.attr('data-component-refresh-loaded',true);NP_component.setComponent(ele,html)}else{html=NP_component.getComponent(ele)}var holder,val;for(var key in objects){holder=new RegExp(NP_config.start+key+NP_config.end,"g");val=objects[key];html=html.replace(holder,val)}var baseObj=$(html);var prevLoad=ele.data('prevLoad');NP_component.loadImg(baseObj,prevLoad);if(!!deal&&typeof deal!='undefined'||deal!=undefined){deal(baseObj)}ele.html(baseObj);ele.find('if').each(function(){var key=$(this).data('key');if(objects[key]!=$(this).data('value')){$(this).remove()}else{$(this).next('else').remove();$($(this).html()).insertAfter($(this));$(this).remove()}})};$.fn.fillData=function(data,deal){var ele=this;var className,obj;for(var key in data){className='data_'+key;obj=ele.find('input.'+className+' , select.'+className+' , textarea.'+className+'select.'+className);if(obj.length!=0){obj.val(data[key])}else{obj=ele.find('img.'+className);if(obj.length!=0){var url=data[key];obj.attr('data-loading',url)}else{obj=ele.find('.'+className);if(obj.length!=0){obj.text(data[key])}}}}var prevLoad=ele.data('prevLoad');NP_component.loadImg(ele,prevLoad);if(!!deal&&typeof deal!='undefined'||deal!=undefined){deal()}};$.fn.getBaseObj=function(){var baseHtml=$('#'+this.data('cmd')).html();return $(baseHtml)};$.fn.getObj=function(){var ele=this;var baseHtml=ele.html();var component=ele.attr('data-component-refresh-loaded');if(!component){ele.attr('data-component-refresh-loaded',true);NP_component.setComponent(ele,baseHtml)}else{baseHtml=NP_component.getComponent(ele)}return $(baseHtml)};$.fn.niepShow=function(){this.addClass(NP_config.showClass)};$.fn.niepHide=function(){this.removeClass(NP_config.showClass)};$.fn.finished=function(){var component=this;var page=component.parents("."+NP_config.baseClass);var count=page.attr('data-count');if(!count){count=0}else{count=count-1}page.attr('data-count',count);var prevLoad=component.data('prevLoad');if(count==0&&prevLoad!='need'){page.pageShow()}else if(prevLoad=='need'){component.data('prevLoad','completed')}};$.fn.ajaxFinished=function(result,success){var component=this;var status=result.status;if(status=='200'){success(result);component.finished()}else if(status=='800'){NP_component.refreshCmd('page_chapter');NP_component.switchPage({target:'needPay',params:result.message})}else if(status=='100'){NP_component.refreshCmd('info_user');var page=result.message;var random=Math.random(9000)+1000;location.href=NP_config.host+"/getCode?page="+page+"&params=1#"+random}else{alerted(result.message)}};$.fn.post=function(postJson,success){var component=this;var url=NP_config.service+"/"+component.data('cmd').replace(new RegExp('_','g'),'/');$.post(url,postJson,function(result){success(result)},'json')};$.fn.pagePost=function(postJson,success){var component=this;var json=!!postJson?postJson:{};json['pageNum']=component.attr('pageNum');var url=NP_config.service+"/"+component.data('cmd').replace(new RegExp('_','g'),'/');$.post(url,json,function(result){success(result)},'json')}})(jQuery);window.onpopstate=function(ev){NP_history.back()};$('body').on('click','.getMoreDataBtn',function(){var ts=$(this);var parent=ts.parent();var page=ts.parents('.page');var params=page.attr('data-params');var cmd=eval(parent.data('cmd'));new cmd(parent,params,page)});var Niep={init:function(configs){for(var key in configs){NP_config[key]=configs[key]}NP_DATA['startParams']=t_getUrlParamsJson();var uid=getCookie('NIEP_UUID');if(!uid){uid=generateUUID();setCookie('NIEP_UUID',uid,30)}NP_DATA['cookieUid']=uid;NP_component.loadResources()},getShowPage:function(){return $('.'+NP_config.baseClass+'.'+NP_config.showClass)},get:function(params,index){var arr=params.split('-');return arr[index]}};$('body').on('click','[data-action="switch"]',function(e){e.preventDefault();var ts=$(this);var cmd=ts.data('cmd');if(!!cmd){var cmds=eval(cmd);new cmds(ts)}var params=ts.attr('data-params');var showingPage=Niep.getShowPage();var tId="page_"+ts.attr('href');if(showingPage.length!=0){showingPage.pageHide(tId,params)}else{var targetPageId=tId;targetPageId="page="+targetPageId.split('_')[1];if(!!params){targetPageId=targetPageId+"&params="+params}if(!!NP_DATA.historyAction){targetPageId=NP_DATA.historyAction+"?"+targetPageId}history.pushState('','',targetPageId)}NP_component.loading(true);var target=$('#'+tId);if(target.length==0){NP_component.loadPage(ts.attr('href'),function(result){target=$(result);target.attr('id',tId);$('body').prepend(target);NP_component.loadResources(params,target,ts)})}else{NP_component.loadResources(params,target,ts)}});